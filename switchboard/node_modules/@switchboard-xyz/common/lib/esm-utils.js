import fs from "fs";
import fsPromises from "fs/promises";
import { dirname, format, join, parse } from "node:path";
/**
 * Merge a dist-cjs directory into a dist directory
 * @param {string} source - the absolute path to the source directory (Ex. /home/runner/dist-cjs)
 * @param {string} dest - the absolte path to the destination directory (Ex. /home/runner/dist)
 */
export function moveCjsFiles(source, dest) {
    const files = fs.readdirSync(source, { withFileTypes: true });
    for (const file of files) {
        if (file.isDirectory()) {
            fs.mkdirSync(join(source, file.name), { recursive: true });
            moveCjsFiles(join(source, file.name), join(dest, file.name));
        }
        else if (file.isFile()) {
            const parsed = parse(file.name);
            // Ignore anything that's not a .js file
            if (parsed.ext !== ".js") {
                continue;
            }
            // Rewrite any require statements to use .cjs
            const content = fs.readFileSync(join(source, file.name), "utf8");
            const rewritten = content.replace(/require\("(\..+?).js"\)/g, (_, p1) => {
                return `require("${p1}.cjs")`;
            });
            // Rename the file to .cjs
            const renamed = format({ name: parsed.name, ext: ".cjs" });
            // console.log(renamed);
            fs.writeFileSync(join(dest, renamed), rewritten, "utf8");
        }
    }
}
/**
 * Merge a dist-cjs directory into a dist directory
 * @param {string} source - the absolute path to the source directory (Ex. /home/runner/dist-cjs)
 * @param {string} dest - the absolte path to the destination directory (Ex. /home/runner/dist)
 */
export async function moveCjsFilesAsync(source, dest) {
    const files = await fsPromises.readdir(source, { withFileTypes: true });
    await Promise.all(files.map(async (file) => {
        if (file.isDirectory()) {
            return await moveCjsFiles(join(source, file.name), join(dest, file.name));
        }
        // its a file
        const parsed = parse(file.name);
        if (parsed.ext !== ".js") {
            return;
        }
        return await fsPromises
            .readFile(join(source, file.name), "utf-8")
            .then(async (content) => {
            const rewritten = content.replace(/require\("(\..+?).js"\)/g, (_, p1) => {
                return `require("${p1}.cjs")`;
            });
            const renamed = format({ name: parsed.name, ext: ".cjs" });
            return await fsPromises.writeFile(join(dest, renamed), rewritten, "utf-8");
        });
    }));
}
const updateJsonFile = (relativePath, updateFunction) => {
    const contents = fs.readFileSync(relativePath, "utf8");
    const res = updateFunction(JSON.parse(contents));
    fs.writeFileSync(relativePath, JSON.stringify(res, null, 2) + "\n");
};
const generateFiles = (entrypoints, dir) => {
    const files = [...Object.entries(entrypoints), ["index", "index"]].flatMap(([key, value]) => {
        const nrOfDots = key.split("/").length - 1;
        const relativePath = "../".repeat(nrOfDots) || "./";
        const compiledPath = `${relativePath}${dir}/${value}.js`;
        return [
            [
                `${key}.cjs`,
                `module.exports = require('${relativePath}${dir}/${value}.cjs');`,
            ],
            [`${key}.js`, `export * from '${compiledPath}'`],
            [`${key}.d.ts`, `export * from '${compiledPath}'`],
        ];
    });
    return Object.fromEntries(files);
};
/**
 * Generates the package.json and tsconfig entrypoints for an ESM/CJS build
 * @param {string} projectDir - the absolute path to a directory containing a package.json and tsconfig.json
 * @param {string} dir - the name of the output directory (Ex. dist)
 * @param {object} entrypoints - a list of entrypoints to their file location, relative to the projectDir
 * @param {boolean} includeSrcDir - whether to include the src directory in the package.json files
 */
export function generateEntrypoints(projectDir, dir, entrypoints, includeSrcDir) {
    // Update tsconfig.json `typedocOptions.entryPoints` field
    updateJsonFile(join(projectDir, "tsconfig.json"), (json) => ({
        ...json,
        typedocOptions: {
            ...json.typedocOptions,
            entryPoints: [...Object.keys(entrypoints)].map((key) => `src/${entrypoints[key]}.ts`),
        },
    }));
    const generatedFiles = generateFiles(entrypoints, dir);
    const filenames = Object.keys(generatedFiles);
    const baseFiles = [`${dir}/`];
    if (includeSrcDir) {
        baseFiles.push("src/");
    }
    // Update package.json `exports` and `files` fields
    updateJsonFile(join(projectDir, "package.json"), (json) => ({
        ...json,
        exports: Object.assign(Object.fromEntries(["index", ...Object.keys(entrypoints)].map((key) => {
            const entryPoint = {
                types: `./${key}.d.ts`,
                import: `./${key}.js`,
                require: `./${key}.cjs`,
            };
            return [key === "index" ? "." : `./${key}`, entryPoint];
        })), { "./package.json": "./package.json" }),
        files: [...baseFiles, "package.json", ...filenames],
    }));
    // Write generated files
    Object.entries(generatedFiles).forEach(([filename, content]) => {
        fs.mkdirSync(dirname(filename), { recursive: true });
        fs.writeFileSync(filename, content);
    });
    // Update .gitignore
    fs.writeFileSync(join(projectDir, ".gitignore"), filenames.join("\n") + "\n");
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXNtLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2VzbS11dGlscy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDcEIsT0FBTyxVQUFVLE1BQU0sYUFBYSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFekQ7Ozs7R0FJRztBQUNILE1BQU0sVUFBVSxZQUFZLENBQUMsTUFBTSxFQUFFLElBQUk7SUFDdkMsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUM5RCxLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQ3pCLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUM7WUFDdkIsRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQzNELFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQy9ELENBQUM7YUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDO1lBQ3pCLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDaEMsd0NBQXdDO1lBQ3hDLElBQUksTUFBTSxDQUFDLEdBQUcsS0FBSyxLQUFLLEVBQUUsQ0FBQztnQkFDekIsU0FBUztZQUNYLENBQUM7WUFDRCw2Q0FBNkM7WUFDN0MsTUFBTSxPQUFPLEdBQUcs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RUFBRSxVQUFVLENBQUMsQ0FBQztRQUMxRCxDQUFDLENBQUMsQ0FDSCxFQUNELEVBQUUsZ0JBQWdCLEVBQUUsZ0JBQWdCLEVBQUUsQ0FDdkM7UUFDRCxLQUFLLEVBQUUsQ0FBQyxHQUFHLFNBQVMsRUFBRSxjQUFjLEVBQUUsR0FBRyxTQUFTLENBQUM7S0FDcEQsQ0FBQyxDQUFDLENBQUM7SUFDSix3QkFBd0I7SUFDeEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsRUFBRSxFQUFFO1FBQzdELEVBQUUsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDckQsRUFBRSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDdEMsQ0FBQyxDQUFDLENBQUM7SUFDSCxvQkFBb0I7SUFDcEIsRUFBRSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLFlBQVksQ0FBQyxFQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7QUFDaEYsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCBmc1Byb21pc2VzIGZyb20gXCJmcy9wcm9taXNlc1wiO1xuaW1wb3J0IHsgZGlybmFtZSwgZm9ybWF0LCBqb2luLCBwYXJzZSB9IGZyb20gXCJub2RlOnBhdGhcIjtcblxuLyoqXG4gKiBNZXJnZSBhIGRpc3QtY2pzIGRpcmVjdG9yeSBpbnRvIGEgZGlzdCBkaXJlY3RvcnlcbiAqIEBwYXJhbSB7c3RyaW5nfSBzb3VyY2UgLSB0aGUgYWJzb2x1dGUgcGF0aCB0byB0aGUgc291cmNlIGRpcmVjdG9yeSAoRXguIC9ob21lL3J1bm5lci9kaXN0LWNqcylcbiAqIEBwYXJhbSB7c3RyaW5nfSBkZXN0IC0gdGhlIGFic29sdGUgcGF0aCB0byB0aGUgZGVzdGluYXRpb24gZGlyZWN0b3J5IChFeC4gL2hvbWUvcnVubmVyL2Rpc3QpXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBtb3ZlQ2pzRmlsZXMoc291cmNlLCBkZXN0KSB7XG4gIGNvbnN0IGZpbGVzID0gZnMucmVhZGRpclN5bmMoc291cmNlLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSk7XG4gIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgIGlmIChmaWxlLmlzRGlyZWN0b3J5KCkpIHtcbiAgICAgIGZzLm1rZGlyU3luYyhqb2luKHNvdXJjZSwgZmlsZS5uYW1lKSwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgICBtb3ZlQ2pzRmlsZXMoam9pbihzb3VyY2UsIGZpbGUubmFtZSksIGpvaW4oZGVzdCwgZmlsZS5uYW1lKSk7XG4gICAgfSBlbHNlIGlmIChmaWxlLmlzRmlsZSgpKSB7XG4gICAgICBjb25zdCBwYXJzZWQgPSBwYXJzZShmaWxlLm5hbWUpO1xuICAgICAgLy8gSWdub3JlIGFueXRoaW5nIHRoYXQncyBub3QgYSAuanMgZmlsZVxuICAgICAgaWYgKHBhcnNlZC5leHQgIT09IFwiLmpzXCIpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICAvLyBSZXdyaXRlIGFueSByZXF1aXJlIHN0YXRlbWVudHMgdG8gdXNlIC5janNcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMoam9pbihzb3VyY2UsIGZpbGUubmFtZSksIFwidXRmOFwiKTtcbiAgICAgIGNvbnN0IHJld3JpdHRlbiA9IGNvbnRlbnQucmVwbGFjZSgvcmVxdWlyZVxcKFwiKFxcLi4rPykuanNcIlxcKS9nLCAoXywgcDEpID0+IHtcbiAgICAgICAgcmV0dXJuIGByZXF1aXJlKFwiJHtwMX0uY2pzXCIpYDtcbiAgICAgIH0pO1xuICAgICAgLy8gUmVuYW1lIHRoZSBmaWxlIHRvIC5janNcbiAgICAgIGNvbnN0IHJlbmFtZWQgPSBmb3JtYXQoeyBuYW1lOiBwYXJzZWQubmFtZSwgZXh0OiBcIi5janNcIiB9KTtcbiAgICAgIC8vIGNvbnNvbGUubG9nKHJlbmFtZWQpO1xuICAgICAgZnMud3JpdGVGaWxlU3luYyhqb2luKGRlc3QsIHJlbmFtZWQpLCByZXdyaXR0ZW4sIFwidXRmOFwiKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBNZXJnZSBhIGRpc3QtY2pzIGRpcmVjdG9yeSBpbnRvIGEgZGlzdCBkaXJlY3RvcnlcbiAqIEBwYXJhbSB7c3RyaW5nfSBzb3VyY2UgLSB0aGUgYWJzb2x1dGUgcGF0aCB0byB0aGUgc291cmNlIGRpcmVjdG9yeSAoRXguIC9ob21lL3J1bm5lci9kaXN0LWNqcylcbiAqIEBwYXJhbSB7c3RyaW5nfSBkZXN0IC0gdGhlIGFic29sdGUgcGF0aCB0byB0aGUgZGVzdGluYXRpb24gZGlyZWN0b3J5IChFeC4gL2hvbWUvcnVubmVyL2Rpc3QpXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtb3ZlQ2pzRmlsZXNBc3luYyhzb3VyY2UsIGRlc3QpIHtcbiAgY29uc3QgZmlsZXMgPSBhd2FpdCBmc1Byb21pc2VzLnJlYWRkaXIoc291cmNlLCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSk7XG4gIGF3YWl0IFByb21pc2UuYWxsKFxuICAgIGZpbGVzLm1hcChhc3luYyAoZmlsZSkgPT4ge1xuICAgICAgaWYgKGZpbGUuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICByZXR1cm4gYXdhaXQgbW92ZUNqc0ZpbGVzKFxuICAgICAgICAgIGpvaW4oc291cmNlLCBmaWxlLm5hbWUpLFxuICAgICAgICAgIGpvaW4oZGVzdCwgZmlsZS5uYW1lKVxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgLy8gaXRzIGEgZmlsZVxuICAgICAgY29uc3QgcGFyc2VkID0gcGFyc2UoZmlsZS5uYW1lKTtcbiAgICAgIGlmIChwYXJzZWQuZXh0ICE9PSBcIi5qc1wiKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGF3YWl0IGZzUHJvbWlzZXNcbiAgICAgICAgLnJlYWRGaWxlKGpvaW4oc291cmNlLCBmaWxlLm5hbWUpLCBcInV0Zi04XCIpXG4gICAgICAgIC50aGVuKGFzeW5jIChjb250ZW50KSA9PiB7XG4gICAgICAgICAgY29uc3QgcmV3cml0dGVuID0gY29udGVudC5yZXBsYWNlKFxuICAgICAgICAgICAgL3JlcXVpcmVcXChcIihcXC4uKz8pLmpzXCJcXCkvZyxcbiAgICAgICAgICAgIChfLCBwMSkgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gYHJlcXVpcmUoXCIke3AxfS5janNcIilgO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG4gICAgICAgICAgY29uc3QgcmVuYW1lZCA9IGZvcm1hdCh7IG5hbWU6IHBhcnNlZC5uYW1lLCBleHQ6IFwiLmNqc1wiIH0pO1xuICAgICAgICAgIHJldHVybiBhd2FpdCBmc1Byb21pc2VzLndyaXRlRmlsZShcbiAgICAgICAgICAgIGpvaW4oZGVzdCwgcmVuYW1lZCksXG4gICAgICAgICAgICByZXdyaXR0ZW4sXG4gICAgICAgICAgICBcInV0Zi04XCJcbiAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9KVxuICApO1xufVxuXG5jb25zdCB1cGRhdGVKc29uRmlsZSA9IChyZWxhdGl2ZVBhdGgsIHVwZGF0ZUZ1bmN0aW9uKSA9PiB7XG4gIGNvbnN0IGNvbnRlbnRzID0gZnMucmVhZEZpbGVTeW5jKHJlbGF0aXZlUGF0aCwgXCJ1dGY4XCIpO1xuICBjb25zdCByZXMgPSB1cGRhdGVGdW5jdGlvbihKU09OLnBhcnNlKGNvbnRlbnRzKSk7XG4gIGZzLndyaXRlRmlsZVN5bmMocmVsYXRpdmVQYXRoLCBKU09OLnN0cmluZ2lmeShyZXMsIG51bGwsIDIpICsgXCJcXG5cIik7XG59O1xuXG5jb25zdCBnZW5lcmF0ZUZpbGVzID0gKGVudHJ5cG9pbnRzLCBkaXIpID0+IHtcbiAgY29uc3QgZmlsZXMgPSBbLi4uT2JqZWN0LmVudHJpZXMoZW50cnlwb2ludHMpLCBbXCJpbmRleFwiLCBcImluZGV4XCJdXS5mbGF0TWFwKFxuICAgIChba2V5LCB2YWx1ZV0pID0+IHtcbiAgICAgIGNvbnN0IG5yT2ZEb3RzID0ga2V5LnNwbGl0KFwiL1wiKS5sZW5ndGggLSAxO1xuICAgICAgY29uc3QgcmVsYXRpdmVQYXRoID0gXCIuLi9cIi5yZXBlYXQobnJPZkRvdHMpIHx8IFwiLi9cIjtcbiAgICAgIGNvbnN0IGNvbXBpbGVkUGF0aCA9IGAke3JlbGF0aXZlUGF0aH0ke2Rpcn0vJHt2YWx1ZX0uanNgO1xuICAgICAgcmV0dXJuIFtcbiAgICAgICAgW1xuICAgICAgICAgIGAke2tleX0uY2pzYCxcbiAgICAgICAgICBgbW9kdWxlLmV4cG9ydHMgPSByZXF1aXJlKCcke3JlbGF0aXZlUGF0aH0ke2Rpcn0vJHt2YWx1ZX0uY2pzJyk7YCxcbiAgICAgICAgXSxcbiAgICAgICAgW2Ake2tleX0uanNgLCBgZXhwb3J0ICogZnJvbSAnJHtjb21waWxlZFBhdGh9J2BdLFxuICAgICAgICBbYCR7a2V5fS5kLnRzYCwgYGV4cG9ydCAqIGZyb20gJyR7Y29tcGlsZWRQYXRofSdgXSxcbiAgICAgIF07XG4gICAgfVxuICApO1xuICByZXR1cm4gT2JqZWN0LmZyb21FbnRyaWVzKGZpbGVzKTtcbn07XG5cbi8qKlxuICogR2VuZXJhdGVzIHRoZSBwYWNrYWdlLmpzb24gYW5kIHRzY29uZmlnIGVudHJ5cG9pbnRzIGZvciBhbiBFU00vQ0pTIGJ1aWxkXG4gKiBAcGFyYW0ge3N0cmluZ30gcHJvamVjdERpciAtIHRoZSBhYnNvbHV0ZSBwYXRoIHRvIGEgZGlyZWN0b3J5IGNvbnRhaW5pbmcgYSBwYWNrYWdlLmpzb24gYW5kIHRzY29uZmlnLmpzb25cbiAqIEBwYXJhbSB7c3RyaW5nfSBkaXIgLSB0aGUgbmFtZSBvZiB0aGUgb3V0cHV0IGRpcmVjdG9yeSAoRXguIGRpc3QpXG4gKiBAcGFyYW0ge29iamVjdH0gZW50cnlwb2ludHMgLSBhIGxpc3Qgb2YgZW50cnlwb2ludHMgdG8gdGhlaXIgZmlsZSBsb2NhdGlvbiwgcmVsYXRpdmUgdG8gdGhlIHByb2plY3REaXJcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gaW5jbHVkZVNyY0RpciAtIHdoZXRoZXIgdG8gaW5jbHVkZSB0aGUgc3JjIGRpcmVjdG9yeSBpbiB0aGUgcGFja2FnZS5qc29uIGZpbGVzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZUVudHJ5cG9pbnRzKFxuICBwcm9qZWN0RGlyLFxuICBkaXIsXG4gIGVudHJ5cG9pbnRzLFxuICBpbmNsdWRlU3JjRGlyXG4pIHtcbiAgLy8gVXBkYXRlIHRzY29uZmlnLmpzb24gYHR5cGVkb2NPcHRpb25zLmVudHJ5UG9pbnRzYCBmaWVsZFxuICB1cGRhdGVKc29uRmlsZShqb2luKHByb2plY3REaXIsIFwidHNjb25maWcuanNvblwiKSwgKGpzb24pID0+ICh7XG4gICAgLi4uanNvbixcbiAgICB0eXBlZG9jT3B0aW9uczoge1xuICAgICAgLi4uanNvbi50eXBlZG9jT3B0aW9ucyxcbiAgICAgIGVudHJ5UG9pbnRzOiBbLi4uT2JqZWN0LmtleXMoZW50cnlwb2ludHMpXS5tYXAoXG4gICAgICAgIChrZXkpID0+IGBzcmMvJHtlbnRyeXBvaW50c1trZXldfS50c2BcbiAgICAgICksXG4gICAgfSxcbiAgfSkpO1xuICBjb25zdCBnZW5lcmF0ZWRGaWxlcyA9IGdlbmVyYXRlRmlsZXMoZW50cnlwb2ludHMsIGRpcik7XG4gIGNvbnN0IGZpbGVuYW1lcyA9IE9iamVjdC5rZXlzKGdlbmVyYXRlZEZpbGVzKTtcbiAgY29uc3QgYmFzZUZpbGVzID0gW2Ake2Rpcn0vYF07XG4gIGlmIChpbmNsdWRlU3JjRGlyKSB7XG4gICAgYmFzZUZpbGVzLnB1c2goXCJzcmMvXCIpO1xuICB9XG4gIC8vIFVwZGF0ZSBwYWNrYWdlLmpzb24gYGV4cG9ydHNgIGFuZCBgZmlsZXNgIGZpZWxkc1xuICB1cGRhdGVKc29uRmlsZShqb2luKHByb2plY3REaXIsIFwicGFja2FnZS5qc29uXCIpLCAoanNvbikgPT4gKHtcbiAgICAuLi5qc29uLFxuICAgIGV4cG9ydHM6IE9iamVjdC5hc3NpZ24oXG4gICAgICBPYmplY3QuZnJvbUVudHJpZXMoXG4gICAgICAgIFtcImluZGV4XCIsIC4uLk9iamVjdC5rZXlzKGVudHJ5cG9pbnRzKV0ubWFwKChrZXkpID0+IHtcbiAgICAgICAgICBjb25zdCBlbnRyeVBvaW50ID0ge1xuICAgICAgICAgICAgdHlwZXM6IGAuLyR7a2V5fS5kLnRzYCxcbiAgICAgICAgICAgIGltcG9ydDogYC4vJHtrZXl9LmpzYCxcbiAgICAgICAgICAgIHJlcXVpcmU6IGAuLyR7a2V5fS5janNgLFxuICAgICAgICAgIH07XG4gICAgICAgICAgcmV0dXJuIFtrZXkgPT09IFwiaW5kZXhcIiA/IFwiLlwiIDogYC4vJHtrZXl9YCwgZW50cnlQb2ludF07XG4gICAgICAgIH0pXG4gICAgICApLFxuICAgICAgeyBcIi4vcGFja2FnZS5qc29uXCI6IFwiLi9wYWNrYWdlLmpzb25cIiB9XG4gICAgKSxcbiAgICBmaWxlczogWy4uLmJhc2VGaWxlcywgXCJwYWNrYWdlLmpzb25cIiwgLi4uZmlsZW5hbWVzXSxcbiAgfSkpO1xuICAvLyBXcml0ZSBnZW5lcmF0ZWQgZmlsZXNcbiAgT2JqZWN0LmVudHJpZXMoZ2VuZXJhdGVkRmlsZXMpLmZvckVhY2goKFtmaWxlbmFtZSwgY29udGVudF0pID0+IHtcbiAgICBmcy5ta2RpclN5bmMoZGlybmFtZShmaWxlbmFtZSksIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZW5hbWUsIGNvbnRlbnQpO1xuICB9KTtcbiAgLy8gVXBkYXRlIC5naXRpZ25vcmVcbiAgZnMud3JpdGVGaWxlU3luYyhqb2luKHByb2plY3REaXIsIFwiLmdpdGlnbm9yZVwiKSwgZmlsZW5hbWVzLmpvaW4oXCJcXG5cIikgKyBcIlxcblwiKTtcbn1cbiJdfQ==